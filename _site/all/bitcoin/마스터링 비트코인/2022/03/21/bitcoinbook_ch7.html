<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/static/img/favicon.ico" />
    <title>마스터링 비트코인 ch7 - 달상자 Blog</title>
    <meta name="author" content="TAEHOON" />
    <meta name="description" content="마스터링 비트코인 ch7" />
    <meta name="keywords" content="마스터링 비트코인 ch7, 달상자 Blog, all, bitcoin, 마스터링 비트코인" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
    <meta content="100002479598118" property="fb:app_id">
    <meta content="달상자 Blog" property="og:site_name">

    

    
      <meta content="마스터링 비트코인 ch7" property="og:title">
      <meta content="article" property="og:type">
    

    
      <meta content="공부하려고 만든 블로그" property="og:description">
    

    
      <meta content="https://hanscom95.github.io/all/bitcoin/%EB%A7%88%EC%8A%A4%ED%84%B0%EB%A7%81%20%EB%B9%84%ED%8A%B8%EC%BD%94%EC%9D%B8/2022/03/21/bitcoinbook_ch7.html" property="og:url">
    

    
      <meta content="2022-03-21T12:00:00+09:00" property="article:published_time">
      <meta content="https://hanscom95.github.io/about/" property="article:author">
    

    

    
      
        <meta content="all" property="article:section">
      
    

    
      
    

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@">
    <meta name="twitter:creator" content="@">

    
      <meta name="twitter:title" content="마스터링 비트코인 ch7">
    

    
      <meta name="twitter:url" content="https://hanscom95.github.io/all/bitcoin/%EB%A7%88%EC%8A%A4%ED%84%B0%EB%A7%81%20%EB%B9%84%ED%8A%B8%EC%BD%94%EC%9D%B8/2022/03/21/bitcoinbook_ch7.html">
    

    
      <meta name="twitter:description" content="공부하려고 만든 블로그">
    

    

    <!-- Font awesome icons -->
    <link href="/static/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/static/css/syntax.css">
    <!-- Bootstrap core CSS -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/super-search.css">
    <link rel="stylesheet" href="/static/css/thickbox.css">
    <link rel="stylesheet" href="/static/css/projects.css">
    <link rel="stylesheet" href="/static/css/main.css">

    
  </head>
  <body>
    <div class="container">
      <div class="col-sm-3">
        <div class="fixed-condition">
          <h1 class="author-name"><a href="/">TAEHOON</a></h1>
          
            <div class="profile-about">
              개발용 공부를 위해 만든 블로그 입니다. 백엔드를 주로 개발하며 프론트, DevOps, 앱, BlockChain 등도 같이 개발하고 있습니다.
            </div>
          
          <div class="social">
            <ul>
              
                <li><a href="https://www.facebook.com/people/%EB%AC%B8%ED%83%9C%ED%9B%88/100002479598118/" target="_blank"><i class="fa fa-facebook"></i></a></li>
              
                <li><a href="https://www.instagram.com/moon_developer_93" target="_blank"><i class="fa fa-instagram"></i></a></li>
              
                <li><a href="https://github.com/hanscom95" target="_blank"><i class="fa fa-github"></i></a></li>
              
            </ul>
          </div>
          <div class="search" id="js-search">
            <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input">
            <ul class="search__results" id="js-search__results"></ul>
          </div>
          <hr />
          <ul class="sidebar-nav">
            <strong>Navigation</strong>
            <li><a href="/">Home</a></li>
            
              <li><a class="about" href="/category/all">Category</a></li>
            
              <li><a class="about" href="/projects/">Project</a></li>
            
              <li><a class="about" href="https://hanscom95.github.io/about">About Me</a></li>
            
          </ul>
        </div>
        <!-- end /.fixed-condition -->
      </div>
      <div class="col-sm-8 col-offset-1 main-layout">
        <header class="post-header">
  <h1 class="post-title">마스터링 비트코인 ch7</h1>
</header>

<span class="time">21 Mar 2022</span>

  <span class="categories">
    &raquo; <a href="/category/all">all</a>, <a href="/category/bitcoin">bitcoin</a>, <a href="/category/마스터링 비트코인">마스터링 비트코인</a>
  </span>


<div class="content">
  <div class="post"><h1 id="마스터링-비트코인-ch7-트랜잭션-및-고급-스크립트">마스터링 비트코인 ch7 트랜잭션 및 고급 스크립트</h1>
<p>이번 장은 앞장에서 다뤘던 내용들의 복잡한 스크립트들을 다룬다.</p>

<h2 id="1-서론">1. 서론</h2>
<p>다중서명을 요구하는 스크립트를 이해 하며 다중서명의 문제를 해결하기 위한 P2SH</p>

<h2 id="2-다중서명multisignature">2. 다중서명(Multisignature)</h2>
<ul>
  <li>이름 그대로 다중서명을 요구하는 스크립트</li>
  <li>잠금에 N개의 공개키가 사용되고, 그 중에 적어도 M개의 서명이 올바르게 제공될 때 잠금이 해제되는 스크립트로 M-of-N으로 표현
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>M  &lt;Public Key 1&gt; &lt;Public Key 2&gt; ... &lt;Public Key N&gt; N CHECKMULTISIG
</code></pre></div>    </div>
  </li>
  <li>해제 스크립트는 다음과 같은 형식
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Signature 1&gt; &lt;Signature 2&gt; ... &lt;Signature M&gt;
</code></pre></div>    </div>
  </li>
  <li>CHECKMULTISIG 구현에는 버그 있음</li>
  <li>M개를 스택에서 꺼내야 하는데 M+1 개를 꺼냄. 이 버그 때문에 연결된 스크립트의 맨 앞에 의미 없는 0을 추가
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 &lt;Signature 1&gt; &lt;Signature 2&gt; ... &lt;Signature M&gt;
</code></pre></div>    </div>
  </li>
  <li>ex) 3개의 공개키 그 중 두 개 이상의 올바른 서명 스크립트는 2-of-3
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0 &lt;Signature B&gt; &lt;Signature C&gt; 2 &lt;Public Key A&gt; &lt;Public Key B&gt; &lt;Public Key C&gt; 3 CHECKMULTISIG
</code></pre></div>    </div>
  </li>
  <li>잠금 스크립트는 출력에 배치되는 지출 조건</li>
  <li>잠금 스크립트는 공개키 또는 비트코인 주소(공개키 해시)가 포함되어 있어 scriptPubKey라 불림</li>
  <li>잠금 해제 스크립트는 잠금 스크립트에 의해 출력에 설정된 조건을 해결하거나 만족시키는 스크립트로 출력을 사용</li>
  <li>잠금 해제 스크립트는 모든 트랜잭션 입력의 일부</li>
  <li>대개의 경우 개인키로 사용잔의 지갑에서 생성된 <strong>디지털 서명</strong>이 있음. scriptSig라 불림</li>
</ul>

<h2 id="3-pay-to-script-hashp2sh">3. Pay-to-Script-Hash(P2SH)</h2>
<ul>
  <li>복잡한 튼랜잭션 스크립트 사용을 좀 더 간단하게 할 수 있도록 2012년에 새롭게 도입</li>
  <li>다중서명 스크립트의 문제를 해결</li>
  <li>M-of-N 다중서명 스크립트 작성방법은 여러 가지 문제중 가장 중요한 트랜잭션 출력의 잠금 스크립트에 N개의 공개키 해시를 가져야 한다는 점. <br />
비트코인은 트랜잭션 출력이 사용되기 전까지 UTXO로 관리, UTXO는 램 메모리를 사용하는 비용이 높음</li>
</ul>

<p>P2SH가 없는 복잡한 스크립트<br />
|  Locking Script    |  2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 CHECKMULTISIG  |    <br />
|  Unlocking Script  |  0 Sig1 Sig2                                                |</p>

<p>P2SH가 있는 복잡한 스크립트    <br />
|  Redeem Script     |  2 PubKey1 PubKey2 PubKey3 PubKey4 PubKey5 5 CHECKMULTISIG  |<br />
|  Locking Script    |  HASH160 &lt;20-byte hash of redeem script&gt; EQUA L             | <br />
|  Unlocking Script  |  0 Sig1 Sig2 <redeem script="">                                |</redeem></p>

<ul>
  <li>P2SH는 공개키 해시 값들을 잠금 스크립트에 포함하지 않고, 별도 스크립트(Redeem Script)로 작성하고 해시 값만을 포함하게 함</li>
</ul>

<h2 id="31-p2sh의-이점">3.1. P2SH의 이점</h2>
<ul>
  <li>복잡한 스크립트를 트랜잭션 출력에서 더 짧은 스크립트로 바뀌어 트랜잭션 크기를 작게 만듬</li>
  <li>스크립트는 비트코인 주소로 코딩될 수 있음, 발시자와 살신자의 지갑에는 P2SH 구현을 위한 복잡한 엔지니어링 필요치 않음</li>
  <li>스크립트를 작성하는 부담을 보낸 사람이 아닌 받는 사람에게 이동</li>
  <li>긴 스크립트의 데이터 저장에 대한 부담을 출력(블록체인에 저장된 것은 UTXO 세트에 있음)에서 입력(블록체인에만 저장됨)으로 이동</li>
  <li>긴 스크립트의 데이터 저장에 대한 부담을 현재 시간에서 미래 시간으로 이동</li>
  <li>긴 스크립트의 거래 수수료 비용을 보낸 사람에게 받는 사람에게 옮김. 긴 스크립트를 사용하려면 받는 사람에게 보내야 함</li>
</ul>

<h2 id="4-타임락timelocks">4. 타임락(Timelocks)</h2>
<p>트랜잭션의 시간을 기준으로 잠궈두는 것. 트랜잭션을 기준으로 적용되는 nLockTime 필드로 구현  <br />
이중지불 문제가 발생할 수 있기 때문에 비트코인 시스템 초기부터 있어 왔지만 거의 사용되지 않음<br />
잠겨 있는 트랜잭션은 특정 시간이 되기 전까지는 트랜잭션을 전송받은 노드에서 유효하지 않은 것이 되어 비트콩니 네트워크로 전파되지 않음. 
따라서 잠금 시간 전까지는 제약사항이 비트코인 시스템 밖에서만 존재하고 비트코인 시스템 내에서는 존재하지 않음</p>
<ul>
  <li>상대적 잠금시간
    <ul>
      <li>트랜잭션 수준이나 스크립트 수준으로 적용 가능</li>
      <li>트랜잭션 수준의 타임락은 트랜잭션 입력마다 작성 가능하며, 트랜잭션 입력 필드 nSequence 로 작성</li>
      <li>nSequence 는 메모리풀에 있는 트랜잭션을 수정할 수 있도록 하기 위한 필드</li>
      <li>값이 0xFFFFFFFF 이면 채굴자들은 블록에 트랜잭션을 포함</li>
      <li>CHECKSEQUENCEVERIFY 등장으로 사용</li>
    </ul>
  </li>
  <li>nSequence를 사용한 상대적 잠금시간<br />
<img src="https://raw.githubusercontent.com/hanscom95/hanscom95.github.io/master/static/img/_posts/bitcoinbook_ch7_1.png" alt="그림1" /><br />
그림1 nSequence encoding의 BIP-68 정의
    <ul>
      <li>2^31보다 작으면 상대 타임락을 갖는 것으로 해석, 그렇지 않으면 상대 타임락이 적용되지 않음</li>
      <li>타임 플래그를 사용해서 블록높이를 사용할 것인지 유닉스 타임스탬프를 사용할 것인지를 정함</li>
      <li>타임플래그는 23번째 비트 값으로 설정</li>
      <li>nSequence 값은 16비트로</li>
      <li>최상위 비트 값은 nSequence 를 적용할 것인지에 대한 여부를 나타냄</li>
      <li>nLockTime과 마찬가지로 nSequence값도 CHECKSEQUENCEVERIFY 입력 값보다 크거나 같아야 함</li>
    </ul>
  </li>
  <li>Median-Time-Past
    <ul>
      <li>비트코인 시스템에서 시간의 정확성에 대해서 생각할 때는 비트코인 시스템이 P2P 네트워크라는 것에 주의</li>
      <li>채굴자에 작성하는 점에도 주의</li>
      <li>BIP-113은 P2P 네트워크에서 발생할 수 밖에 없는 시간 정확성 문제를 해결하기 위해 Median-Time-Past 방법을 정의</li>
      <li>최근 11개의 블록들의 타임스탬프를 가지고 중간값을 구하고, 그 값을 시간 제약과 관련된 계산에 사용</li>
    </ul>
  </li>
</ul>

<h2 id="5-흐름제어기능을-가진-스크립트">5. 흐름제어기능을 가진 스크립트</h2>
<ul>
  <li>비트코인 스크립트의 조건부 절을 흐름제어라 불림. IF, THEN, ELSE 등의 구문을 사용.</li>
  <li>표현식 무한 중첩 가능</li>
  <li>조건부가 다른 조건을 포함할 수 있음</li>
  <li>스크립트 언어 역방향</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>condition
IF
  code to run when condition is true
ELSE
  code to run when condition is false
ENDIF
code to run in either case
</code></pre></div></div>

<h2 id="-참고문서">○ 참고문서</h2>
<ul>
  <li><a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch07.asciidoc">bitcoinbook</a></li>
</ul>
</div>
  <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId=100002479598118";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

</div>


  
    
      
        
          
            
            <div class="panel-body">
              <h4>Related Posts</h4>
              <ul>
            
                <li class="relatedPost">
                  <a href="https://hanscom95.github.io/all/docker/ubuntu/2022/06/20/docker-nexus-repository.html">Docker & Nexus3 Registry 설치 가이드</a>
                  
                    (Categories: <a href="/category/all">all</a>, <a href="/category/docker">docker</a>, <a href="/category/ubuntu">ubuntu</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://hanscom95.github.io/all/bitcoin/%EB%A7%88%EC%8A%A4%ED%84%B0%EB%A7%81%20%EB%B9%84%ED%8A%B8%EC%BD%94%EC%9D%B8/2022/05/31/bitcoinbook_ch10.html">마스터링 비트코인 ch10</a>
                  
                    (Categories: <a href="/category/all">all</a>, <a href="/category/bitcoin">bitcoin</a>, <a href="/category/마스터링 비트코인">마스터링 비트코인</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://hanscom95.github.io/all/bitcoin/%EB%A7%88%EC%8A%A4%ED%84%B0%EB%A7%81%20%EB%B9%84%ED%8A%B8%EC%BD%94%EC%9D%B8/2022/05/24/bitcoinbook_ch9.html">마스터링 비트코인 ch9</a>
                  
                    (Categories: <a href="/category/all">all</a>, <a href="/category/bitcoin">bitcoin</a>, <a href="/category/마스터링 비트코인">마스터링 비트코인</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://hanscom95.github.io/all/flutter/issue/tip/2022/04/25/flutter-tip.html">Flutter Project clean</a>
                  
                    (Categories: <a href="/category/all">all</a>, <a href="/category/flutter">flutter</a>, <a href="/category/issue">issue</a>, <a href="/category/tip">tip</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://hanscom95.github.io/all/bitcoin/%EB%A7%88%EC%8A%A4%ED%84%B0%EB%A7%81%20%EB%B9%84%ED%8A%B8%EC%BD%94%EC%9D%B8/2022/04/13/bitcoinbook_ch8.html">마스터링 비트코인 ch8</a>
                  
                    (Categories: <a href="/category/all">all</a>, <a href="/category/bitcoin">bitcoin</a>, <a href="/category/마스터링 비트코인">마스터링 비트코인</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
            
                <li class="relatedPost">
                  <a href="https://hanscom95.github.io/all/did/ubuntu/docker/issue/2022/03/15/evernym-mobile-sdk-simple-sponsor.html">evernym mobile sdk - simple sponsor</a>
                  
                    (Categories: <a href="/category/all">all</a>, <a href="/category/DID">DID</a>, <a href="/category/ubuntu">ubuntu</a>, <a href="/category/docker">docker</a>, <a href="/category/issue">issue</a>)
                  
                </li>
          
          
        
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
        
          
      
          
      
          
      
    
  
    
      
        
          
      
          
      
          
      
    
  
  
  </ul>
</div>


<div class="PageNavigation">
  
    <a class="prev" href="/all/did/ubuntu/docker/issue/2022/03/15/evernym-mobile-sdk-simple-sponsor.html">&laquo; evernym mobile sdk - simple sponsor</a>
  
  
    <a class="next" href="/all/bitcoin/%EB%A7%88%EC%8A%A4%ED%84%B0%EB%A7%81%20%EB%B9%84%ED%8A%B8%EC%BD%94%EC%9D%B8/2022/04/13/bitcoinbook_ch8.html">마스터링 비트코인 ch8 &raquo;</a>
  
</div>

<div class="disqus-comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* <![CDATA[ */
    var disqus_shortname = "hanscom95";
    var disqus_identifier = "https://hanscom95.github.io_마스터링 비트코인 ch7";
    var disqus_title = "마스터링 비트코인 ch7";

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    /* ]]> */
  </script>
</div>

        <footer>
          &copy; TAEHOON
          
            - <a href="https://github.com/hanscom95">https://github.com/hanscom95</a> - Powered by Jekyll.
          
          <div class="btn-github" style="float:right;">
            <iframe src="https://ghbtns.com/github-btn.html?user=hanscom95&repo=hanscom95.github.io&type=star&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe>
            <iframe src="https://ghbtns.com/github-btn.html?user=hanscom95&repo=hanscom95.github.io&type=fork&count=true" frameborder="0" scrolling="0" width="100" height="20px"></iframe>
          </div>
        </footer>
      </div>
      <!-- end /.col-sm-8 -->
    </div>
    <!-- end /.container -->

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/super-search.js"></script>
    <script src="/static/js/thickbox-compressed.js"></script>
    <script src="/static/js/projects.js"></script>
  </body>
</html>

